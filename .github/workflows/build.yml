name: Build Seat Adjuster

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Check out the code
    - uses: actions/checkout@v4

    # 2. Set up Python 3.10
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Install CMake
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.25'

    # 4. Generate Vehicle Model (With Folder Fix)
    - name: Generate Vehicle Model
      run: |
        python -m pip install conan velocitas-model-generator jinja2

        echo "--- DOWNLOADING VSS v4.0 DATA ---"
        wget https://github.com/COVESA/vehicle_signal_specification/releases/download/v4.0/vss_rel_4.0.json -O vss.json
        wget https://raw.githubusercontent.com/COVESA/vehicle_signal_specification/v4.0/spec/units.yaml -O units.yaml

        echo "--- PREPARING FOLDERS ---"
        # Ensure the 'vehicle' directory exists so C++ can do #include "vehicle/Vehicle.h"
        mkdir -p examples/seat-adjuster/src/vehicle

        echo "--- RUNNING GENERATOR ---"
        cat <<EOF > run_gen.py
        import sys
        try:
            from velocitas.model_generator.cli import main
        except ImportError:
            from velocitas_model_generator.cli import main

        # Target the 'vehicle' subfolder explicitly
        sys.argv = [
            'velocitas-model-generator',
            '-u', 'units.yaml',
            '-l', 'cpp',
            '-T', 'examples/seat-adjuster/src/vehicle',
            'vss.json'
        ]
        
        print(f"Generating into src/vehicle...")
        main()
        EOF
        
        python run_gen.py
        
        echo "--- VERIFYING & FIXING PATHS ---"
        # Debug: List what was generated so we aren't blind
        find examples/seat-adjuster/src -name "Vehicle.h"
        
        # FAIL-SAFE: If the tool generated 'Vehicle.h' inside 'src/vehicle/vehicle' (double nested)
        # or just 'src/vehicle', we standardize it here.
        
        if [ -f "examples/seat-adjuster/src/vehicle/Vehicle.h" ]; then
            echo "SUCCESS: File found in expected location."
        elif [ -f "examples/seat-adjuster/src/Vehicle.h" ]; then
            echo "WARNING: File found in root src. Moving to src/vehicle..."
            mv examples/seat-adjuster/src/Vehicle.h examples/seat-adjuster/src/vehicle/
            mv examples/seat-adjuster/src/Vehicle.cpp examples/seat-adjuster/src/vehicle/ || true
        else
            echo "CRITICAL ERROR: Vehicle.h was not generated. Listing src folder:"
            ls -R examples/seat-adjuster/src
            exit 1
        fi

    # 5. Build the App
    - name: Build Seat Adjuster
      run: |
        conan profile detect --force
        conan install . --output-folder=build --build=missing -s build_type=Release
        
        cd build
        cmake .. -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Release
        cmake --build . --target seat-adjuster
