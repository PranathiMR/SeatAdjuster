name: Build Seat Adjuster

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Check out the code
    - uses: actions/checkout@v4

    # 2. Set up Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Install CMake
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.25'

    # 4. Generate Vehicle Model (With Post-Processing Fix)
    - name: Generate Vehicle Model
      run: |
        python -m pip install conan velocitas-model-generator jinja2

        echo "--- DOWNLOADING VSS v4.0 DATA ---"
        wget https://github.com/COVESA/vehicle_signal_specification/releases/download/v4.0/vss_rel_4.0.json -O vss.json
        wget https://raw.githubusercontent.com/COVESA/vehicle_signal_specification/v4.0/spec/units.yaml -O units.yaml

        echo "--- PREPARING FOLDERS ---"
        # Create target directory
        TARGET_DIR="examples/seat-adjuster/src/vehicle"
        mkdir -p "$TARGET_DIR"

        echo "--- RUNNING GENERATOR ---"
        cat <<EOF > run_gen.py
        import sys
        try:
            from velocitas.model_generator.cli import main
        except ImportError:
            from velocitas_model_generator.cli import main

        sys.argv = [
            'velocitas-model-generator',
            '-u', 'units.yaml',
            '-l', 'cpp',
            '-T', '$TARGET_DIR',
            'vss.json'
        ]
        
        main()
        EOF
        
        python run_gen.py
        
        echo "--- FIXING FILE STRUCTURE ---"
        # The generator creates a nested structure: src/vehicle/include/vehicle/...
        # We need to move those files UP to src/vehicle/ so the compiler finds them.
        
        if [ -d "$TARGET_DIR/include/vehicle" ]; then
            echo "Flattening nested folder structure..."
            cp -r $TARGET_DIR/include/vehicle/* $TARGET_DIR/
            rm -rf $TARGET_DIR/include
        fi
        
        # FIX: The app expects 'Vehicle.h' but we generated 'Vehicle.hpp'.
        # We create a copy named 'Vehicle.h' to satisfy the compiler.
        if [ -f "$TARGET_DIR/Vehicle.hpp" ]; then
            echo "Creating Vehicle.h compatibility link..."
            cp "$TARGET_DIR/Vehicle.hpp" "$TARGET_DIR/Vehicle.h"
        fi

        # Final Verification
        if [ -f "$TARGET_DIR/Vehicle.h" ] || [ -f "$TARGET_DIR/Vehicle.hpp" ]; then
            echo "SUCCESS: Vehicle model generated and positioned correctly."
            ls -l $TARGET_DIR
        else
            echo "CRITICAL ERROR: Headers missing after fix."
            exit 1
        fi

   # 5. Build the App (Using Presets)
    - name: Build Seat Adjuster
      run: |
        # 1. Setup Conan
        conan profile detect --force
        
        # 2. Install dependencies
        # This generates 'CMakeUserPresets.json' in your root folder
        conan install . --output-folder=build --build=missing -s build_type=Release
        
        echo "--- STARTING BUILD WITH PRESETS ---"
        
        # 3. Configure using the generated preset
        # (No need to guess where toolchain.cmake is, the preset knows)
        cmake --preset conan-release
        
        # 4. Compile
        cmake --build --preset conan-release --target seat-adjuster
