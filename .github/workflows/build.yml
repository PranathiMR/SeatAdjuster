name: Build Seat Adjuster (Clean PATH Fix)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Check out the code
    - uses: actions/checkout@v4

    # 2. Set up Python 3.10
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Install CMake 3.25
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.25'

    # 4. Install Dependencies & Fix System PATH
    - name: Setup Build Environment
      run: |
        # Install all Python tools
        python -m pip install conan velocitas-model-generator jinja2

        # --- THE GLOBAL PATH FIX ---
        # Find Python's binary/scripts directories using two methods
        BIN_PATH_1=$(python -c "import sys; print(sys.prefix + '/bin')")
        BIN_PATH_2=$(python -c "import sysconfig; print(sysconfig.get_path('scripts'))")
        
        # Add both to the $GITHUB_PATH. This makes 'velocitas-model-generator'
        # available to ALL subsequent steps in the job.
        echo "$BIN_PATH_1" >> $GITHUB_PATH
        echo "$BIN_PATH_2" >> $GITHUB_PATH
        
        echo "Added Python bin directories to system PATH."

    # 5. Manually Generate Vehicle Model (from PATH)
    - name: Generate Vehicle Model (Manual)
      run: |
        echo "--- DOWNLOADING VSS v4.0 DATA ---"
        wget https://github.com/COVESA/vehicle_signal_specification/releases/download/v4.0/vss_rel_4.0.json -O vss.json
        wget https://raw.githubusercontent.com/COVESA/vehicle_signal_specification/v4.0/spec/units.yaml -O units.yaml

        echo "--- PREPARING FOLDERS ---"
        TARGET_DIR="examples/seat-adjuster/src/vehicle"
        mkdir -p "$TARGET_DIR"

        echo "--- RUNNING GENERATOR (from PATH) ---"
        # We no longer use a Python script. We call the tool directly
        # to prove that our PATH fix in Step 4 worked.
        velocitas-model-generator \
          -N velocitas \
          -u units.yaml \
          -l cpp \
          -T $TARGET_DIR \
          vss.json
        
        echo "--- POST-PROCESSING FILE STRUCTURE ---"
        # Find the .hpp file inside the target dir, wherever it was nested
        HPP_FILE=$(find $TARGET_DIR -name "Vehicle.hpp" | head -n 1)
        
        if [ -z "$HPP_FILE" ]; then
            echo "CRITICAL ERROR: find could not locate Vehicle.hpp in $TARGET_DIR"
            ls -R $TARGET_DIR
            exit 1
        fi
        
        echo "Found Vehicle.hpp at $HPP_FILE, moving all generated files..."
        
        # Move all .hpp/.cpp files from the nested dir up to the target dir
        GENERATED_DIR=$(dirname "$HPP_FILE")
        if [ "$GENERATED_DIR" != "$TARGET_DIR" ]; then
            mv $GENERATED_DIR/* $TARGET_DIR/
        fi
        
        # Create the .h compatibility copy
        cp "$TARGET_DIR/Vehicle.hpp" "$TARGET_DIR/Vehicle.h"
        
        echo "Copied files to $TARGET_DIR"
        ls -l $TARGET_DIR

    # 6. Build the App
    - name: Build Seat Adjuster
      run: |
        conan profile detect --force
        conan install . --output-folder=build --build=missing -s build_type=Release
        
        echo "--- CONFIGURING CMAKE ---"
        # We no longer use any hacks (-D flags or shims)
        cmake --preset conan-release
        
        echo "--- COMPILING ---"
        # This will now succeed because when CMake tries to run the
        # generator, it will find it in the global PATH we set in Step 4.
        cmake --build --preset conan-release
