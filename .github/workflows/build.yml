name: Build Seat Adjuster

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Check out the code
    - uses: actions/checkout@v4

    # 2. Set up Python 3.10
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Install CMake 3.25
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.25'

    # 4. Install Dependencies
    - name: Install Dependencies
      run: |
        # Install all Python tools
        python -m pip install conan velocitas-model-generator jinja2

    # 5. Manually Generate Vehicle Model (via Python Script)
    - name: Generate Vehicle Model (Manual)
      run: |
        echo "--- DOWNLOADING VSS v4.0 DATA ---"
        wget https://github.com/COVESA/vehicle_signal_specification/releases/download/v4.0/vss_rel_4.0.json -O vss.json
        wget https://raw.githubusercontent.com/COVESA/vehicle_signal_specification/v4.0/spec/units.yaml -O units.yaml

        # --- PREPARING FOLDERS ---
        TARGET_DIR="examples/seat-adjuster/src/vehicle"
        mkdir -p "$TARGET_DIR"

        # This is a temporary folder we tell the generator to use
        GENERATOR_OUTPUT_DIR="temp_gen_output"
        mkdir -p "$GENERATOR_OUTPUT_DIR"

        echo "--- RUNNING GENERATOR (via Python Script) ---"
        # This script bypasses all PATH issues
        cat <<EOF > run_gen.py
        import sys
        
        try:
            from velocitas.model_generator.cli import main
        except ImportError:
            from velocitas_model_generator.cli import main

        # Includes the C++ Namespace Fix (-N velocitas)
        sys.argv = [
            'velocitas-model-generator',
            '-N', 'velocitas',
            '-u', 'units.yaml',
            '-l', 'cpp',
            '-T', '$GENERATOR_OUTPUT_DIR',
            'vss.json'
        ]
        
        main()
        EOF
        
        # Run the real generator
        python run_gen.py
        
        echo "--- POST-PROCESSING (FIND & MOVE) ---"
        # Use 'find' to locate the generated files
        HPP_FILE=$(find $GENERATOR_OUTPUT_DIR -name "Vehicle.hpp" | head -n 1)
        
        if [ -z "$HPP_FILE" ]; then
            echo "CRITICAL ERROR: find could not locate Vehicle.hpp"
            ls -R $GENERATOR_OUTPUT_DIR
            exit 1
        fi
        
        # Move all .hpp/.cpp files from the nested dir up to the target dir
        GENERATED_DIR=$(dirname "$HPP_FILE")
        if [ "$GENERATED_DIR" != "$TARGET_DIR" ]; then
            mv $GENERATED_DIR/* $TARGET_DIR/
        fi
        
        # Includes the Header Fix (copy .hpp to .h)
        cp "$TARGET_DIR/Vehicle.hpp" "$TARGET_DIR/Vehicle.h"
        
        echo "Copied all generated files to $TARGET_DIR"

 # 6. Build the App
    - name: Build Seat Adjuster
      run: |
        conf_file="examples/seat-adjuster/CMakeLists.txt"
        
        conan profile detect --force
        conan install . --output-folder=build --build=missing -s build_type=Release
        
        echo "--- PATCHING CMAKEFILE ---"
        # --- THE "No such file" FIX (Append Strategy) ---
        # Instead of editing the file, we simply ADD a new link command to the end.
        # CMake allows this and will combine them. This cannot fail due to formatting.
        echo "" >> $conf_file
        echo "target_link_libraries(example-seatadjusterapp PRIVATE velocitas-sdk::vehicle-app-sdk)" >> $conf_file

        # Verify the patch worked
        echo "--- Verifying patch: ---"
        tail -n 5 $conf_file
        grep "velocitas-sdk::vehicle-app-sdk" $conf_file
        if [ $? -ne 0 ]; then
            echo "CRITICAL: Patching CMakeLists.txt failed."
            exit 1
        fi
        
        echo "--- CONFIGURING CMAKE ---"
        # We tell CMake to DISABLE its internal generator step
        cmake --preset conan-release -DVELOCITAS_GENERATE_MODEL=OFF
        
        echo "--- COMPILING ---"
        # CMake will now compile successfully
        cmake --build --preset conan-release
