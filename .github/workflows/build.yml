name: Build Seat Adjuster

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Check out the code
    - uses: actions/checkout@v4

    # 2. Set up Python 3.10 (Standard for this SDK)
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Install CMake
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.25'

   # 4. Install Dependencies & Generate Model (Auto-Locate File)
    - name: Install Dependencies & Generate Model
      run: |
        python -m pip install conan velocitas-model-generator jinja2
        
        echo "--- AUTO-LOCATING MANIFEST FILE ---"
        # Find the file named 'AppManifest.json' anywhere in the repo
        MANIFEST_PATH=$(find . -name AppManifest.json | head -n 1)
        
        if [ -z "$MANIFEST_PATH" ]; then
            echo "CRITICAL ERROR: Could not find AppManifest.json anywhere!"
            find . -maxdepth 3 # List files to help debug
            exit 1
        fi
        
        echo "Found manifest at: $MANIFEST_PATH"
        
        # Calculate the source directory (usually ../src relative to the app folder)
        # We assume the standard structure: .../app/AppManifest.json -> .../src
        APP_DIR=$(dirname "$MANIFEST_PATH")
        SRC_DIR="$APP_DIR/../src"
        
        echo "Targeting Source Directory: $SRC_DIR"
        
        echo "--- RUNNING GENERATOR ---"
        
        # Create the execution script using the found paths
        cat <<EOF > run_gen.py
        import sys
        try:
            from velocitas.model_generator.cli import main
        except ImportError:
            from velocitas_model_generator.cli import main

        # Use the paths we found dynamically
        sys.argv = [
            'velocitas-model-generator',
            '-l', 'cpp',
            '-T', '$SRC_DIR',
            '$MANIFEST_PATH'
        ]
        
        main()
        EOF
        
        # Run it
        python run_gen.py
        
        # Setup Conan
        conan profile detect --force
        conan install . --output-folder=build --build=missing -s build_type=Release
    # 5. Build the App
    - name: Build Seat Adjuster
      run: |
        # Setup Conan profile
        conan profile detect --force
        
        # Install C++ libraries
        conan install . --output-folder=build --build=missing -s build_type=Release
        
        # Compile
        cd build
        cmake .. -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Release
        cmake --build . --target seat-adjuster
