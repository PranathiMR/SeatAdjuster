name: Build Seat Adjuster

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Check out the code
    - uses: actions/checkout@v4

    # 2. Set up Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Install CMake
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.25'

    # 4. Install Dependencies & Fix PATH
    - name: Setup Build Environment
      run: |
        # Install the tools
        python -m pip install conan velocitas-model-generator jinja2

        # CRITICAL FIX: Add Python Scripts folder to $GITHUB_PATH
        # This makes 'velocitas-model-generator' visible to CMake in the next steps
        PYTHON_BIN=$(python -c "import sys; print(sys.prefix + '/bin')")
        echo "$PYTHON_BIN" >> $GITHUB_PATH
        echo "Added $PYTHON_BIN to PATH"

    # 5. Prepare Vehicle Model (Downloads & Manual Gen)
    - name: Generate Vehicle Model
      run: |
        echo "--- DOWNLOADING VSS v4.0 DATA ---"
        # Download VSS files to the root so CMake can find them easily
        wget https://github.com/COVESA/vehicle_signal_specification/releases/download/v4.0/vss_rel_4.0.json -O vss.json
        wget https://raw.githubusercontent.com/COVESA/vehicle_signal_specification/v4.0/spec/units.yaml -O units.yaml

        echo "--- MANUAL GENERATION (Fail-Safe) ---"
        # We run this manually to ensure files exist before CMake starts
        # Now that PATH is fixed, we can call the tool directly!
        velocitas-model-generator \
          -u units.yaml \
          -l cpp \
          -T examples/seat-adjuster/src/vehicle \
          vss.json
        
        echo "--- POST-PROCESSING ---"
        # Flatten the directory structure if nested (Common issue)
        TARGET_DIR="examples/seat-adjuster/src/vehicle"
        
        if [ -d "$TARGET_DIR/include/vehicle" ]; then
            cp -r $TARGET_DIR/include/vehicle/* $TARGET_DIR/
        fi
        
        # Compatibility Link (Vehicle.hpp -> Vehicle.h)
        if [ -f "$TARGET_DIR/Vehicle.hpp" ]; then
            cp "$TARGET_DIR/Vehicle.hpp" "$TARGET_DIR/Vehicle.h"
        fi

    # 6. Build the App
    - name: Build Seat Adjuster
      run: |
        conan profile detect --force
        conan install . --output-folder=build --build=missing -s build_type=Release
        
        echo "--- BUILDING ---"
        # Using the preset is the safest way
        cmake --preset conan-release
        
        # Build Everything (The Seat Adjuster is part of 'all')
        cmake --build --preset conan-release
