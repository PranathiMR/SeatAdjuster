name: Build Seat Adjuster

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Check out the code
    - uses: actions/checkout@v4

    # 2. Set up Python 3.10 (Standard for this SDK)
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Install CMake
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.25'

    # 4. Install & Run Generator (The Fix)
    - name: Install Dependencies & Generate Model
      run: |
        # Install tools using the current python interpreter
        python -m pip install conan velocitas-model-generator jinja2
        
        echo "Generating Vehicle Model..."
        
        # FIX: Use the 'dot' notation for the namespace package
        python -m velocitas.model_generator -m examples/seat-adjuster/app/AppManifest.json -l cpp -T examples/seat-adjuster/src
        
        # Verify file creation
        if [ -f "examples/seat-adjuster/src/vehicle/Vehicle.h" ]; then
            echo "SUCCESS: Vehicle.h was generated!"
        else
            echo "ERROR: Generation failed."
            exit 1
        fi

    # 5. Build the App
    - name: Build Seat Adjuster
      run: |
        # Setup Conan profile
        conan profile detect --force
        
        # Install C++ libraries
        conan install . --output-folder=build --build=missing -s build_type=Release
        
        # Compile
        cd build
        cmake .. -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Release
        cmake --build . --target seat-adjuster
