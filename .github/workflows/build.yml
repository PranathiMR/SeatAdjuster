name: Build Seat Adjuster

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04  # Running on Linux avoids all your Windows issues

    steps:
    # 1. Check out your code
    - uses: actions/checkout@v4

    # 2. Install Python (Required for Conan)
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10' 

    # 3. Install CMake (The Builder)
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.25'

   # 4. Install Dependencies & Generate Model (Search & Execute)
    - name: Install Dependencies & Generate Model
      run: |
        pip install conan velocitas-model-generator jinja2
        
        echo "--- SEARCHING FOR GENERATOR ---"
        # 1. Get the Python installation root folder
        PY_ROOT=$(python -c "import sys; print(sys.prefix)")
        
        # 2. Find the file 'velocitas-model-generator' anywhere inside that folder
        # We use 'head -n 1' to grab the first match found
        TOOL_PATH=$(find "$PY_ROOT" -name "velocitas-model-generator" -type f | head -n 1)
        
        if [ -z "$TOOL_PATH" ]; then
          echo "CRITICAL ERROR: Could not find velocitas-model-generator script."
          echo "Listing installed files to debug:"
          pip show -f velocitas-model-generator
          exit 1
        fi
        
        echo "FOUND TOOL AT: $TOOL_PATH"
        
        # 3. Execute the found tool
        $TOOL_PATH -m examples/seat-adjuster/app/AppManifest.json -l cpp -T examples/seat-adjuster/src
        
        # Setup Conan
        conan profile detect --force
        conan install . --output-folder=build --build=missing -s build_type=Release
    # 5. Install SDK Dependencies
    # We add -g CMakeDeps -g CMakeToolchain to ensure presets are generated
    - name: Install Dependencies
      run: |
        conan install . --output-folder=build --build=missing -s build_type=Release

    # 6. Build the Application using Presets
    # This automatically finds the toolchain file wherever Conan put it
    - name: Build
      run: |
        cmake --preset conan-release
        cmake --build --preset conan-release
